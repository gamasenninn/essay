#  近況報告 - ワークフローでプチ革命

ワシの職業はというと  
プログラマーとしかいえない  
だが、実際の内容はITのなんでも屋みたいなものだ  
個人事業主だが、あるひとつの会社に所属して  
外注業者としてIT関連の実務をこなしている  
これは巷では「一人SIer」とか「社内SE」といわれているものだ  
だが、ワシはなんでも屋でもないし、  
webデザイナーでもないし、  
仕様決めしたくないし、  
人に指示出ししたくないし、  
パソコンの故障対応とかしたくないし、  
プログラミングを主体にしたいので  
「社内プログラマー」という位置づけで考えている  

この会社、ITに関しては最も遠い会社だったが  
「社内プログラマー」がいるかことで    
今では、かなりモダンなシステムが展開できている（と思う）

すべて手作業だったものを  
かなり自動化した  
商品の管理は量質ともに飛躍的に向上した  
なので、多少は役にたっている（と思う）

自動化したとはいえ  
各種アプリは自分で起動しなければならない  
バッチ（まとまった処理プログラム）起動後も  
成功、失敗の結果で事後処理が違ってくる  
ネットから収集する情報はスクレイピング技術なので  
サイトの仕様で頻繁に収集が失敗したりする  
その場合は、電光石火でプログラムを修正しなければならない    
予想以上にその作業は多い 
  
また、バッチ処理の順序  
A->B->C  
B-D  
C,D->E  
みたいなルールがあるので、
これはやはり自分がやらないといけない  

だから時間で起動するCRONとかじゃ  
全体のバッチを制御して、自動化できんのである  

数ヶ月前までのワシの午前中の仕事は次のとおり

1. ネットからターゲット商品の情報を収集（するバッチを動かす）  
2. Googleスプレッドシートから販売情報をDBに格納（するバッチを動かす）  
3. 更新された商品情報をクラウドにアップ（するバッチを動かす）  
4. 市場にデプロイした商品情報をクラウドにアップ（するバッチを動かす)  
5. ネット市場の商品のアクセス情報を収集してDBに格納（するバッチを動かす）  
6. 商品ごとのアクセス統計をクラウドにアップ（するバッチを動かす）
7. 第一市場の価格に合わせて第2市場、第3市場の価格を訂正（するバッチを動かす）  
8. それぞれの市場の販売ステータスの更新漏れを調整（これは手作業）  

これは・・・社内プログラマーではなく  
普通にオペレーターである  
なにもなければボタンを押すだけなので 
ボタン操作要員というわけだ  
エラー対応の保険としての存在意義しかない  
ぜひとも、この時間をプログラミングに回したい  

そこで導入したのはワークフロー管理システムである  
上のようなバッチ処理を自動化するものはないか？  

オープンソースのそれはいくつかあった
- apache airflow  
- prefect  

そしてワシはprefectを選んだ
理由としては  
- タスクの順序が定義できる（DAG=有向非巡回グラフ）
- タスクを動かすホストマシンにエージェントを組み込めば、クラウドで管理できる
- DAGの制御はyamlでなくpython
- オープンソース
- 時間でのスケジュールと任意の起動
- slack連携

大型汎用コンピュータ時代にJCLという  
バッチ処理を受けもつ言語があったが  
JCL書いてJOBキューに投入し
動いているかどうかモニタリングしていた  
昭和世代なら知っているJOBモニターみたいなやつだ  
たぶん今のエンジニアは誰も知らないだろうな

prefectの場合、pythonでバッチ制御が可能なので  
かなりきめ細かいDAG制御が可能  
リトライ、ストップ、リスタート、スキップが思いのままなのだ  
クラウド上でフロー（バッチ）がモニターでき  
任意にフロー起動もできるのがよい  
しかも、処理本体はクラウドになく、バッチホスト側にあるので  
セキュリティの心配が少ない  

エラーストップのときのログが管理画面から確認できるので 
エラーを修正して再度当該フローを起動できる  

pythonistaとしてpythonだけでプログラミングできるので  
ワシにとってはとても相性がよい  
  
バッチを動かすホスト本体が物理的に分散しているので  
それをクラウドで統合することができた  
  
なによりビジュアルにフローの実行状況を確認できることが  
とても大きな安心感につながった  
  
これを導入してから、午前中の作業は  
8. それぞれの市場の販売ステータスの更新漏れを調整  
だけとなった  
  
他人がみたらブラウザでイコライザーみたいなバーが  
ビコピコ動いているだけの画面  
それを、ボーっと眺めているだけの老人がいるだけで  
このひとほんと仕事してんの？  
ってなるだろうね  
  
おかげで、午前中の作業はほとんど自動化でき  
あいた時間をプログラミングに回すことができた  
だれも知らない変化なのだが  
ワシにとってはちょっとした革命だったよ  
だが、ひいては全体の業務の変革につながる（と思う）

中小企業のみなさん!  
今は、RPAなんて当然のレベルです  
もっと先をみよう  
ワークフロー管理は社内業務にプチ革命をもたらしますぞ!  
社内プログラマーを育ててみませんか  
どこかの自転車置場に落ちているかもしれない  
あなたを見て  
「ぼくを拾ってください。しつけのできた良い子です」  
とニコって笑いかけてくるかもしれない  
その子がいつかあなたの会社に変革をもたらすかもしれない  
